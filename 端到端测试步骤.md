# 需求分析 Orchestrator：从新会话到最终文档（端到端测试步骤）

本文档说明如何**从新会话开始，完整走通「系统改动点」需求分析流程**，直到产出最终文档。适用于手工测试与联调。

---

## 一、前置条件

1. **知识库与向量检索可用**
   - `trading-knowledge-base` 的 `config.txt` 已配置 `api: <text-embedding /search 地址>`；
   - text-embedding 的 api_server 已启动（向量库可检索）。

2. **RS-Agent 后端已启动**
   - 工作目录在 RS-Agent 根目录，执行：`uvicorn backend.app:app --reload`（或等价命令）；
   - 健康检查：`GET /health` 返回正常。

3. **RS-Agent 前端已启动**（可选，也可用 curl 直连后端）
   - 若用前端：`npm run dev`，并确保请求会代理到后端 `/api`。

---

## 二、流程概览（状态与回合）

| 回合 | 用户操作 | 后端状态 | 预期返回 |
|------|----------|----------|----------|
| 1 | 发送「系统改动点」类需求（无 sessionId） | COLLECT → WAITING_ANSWERS | OPEN_QUESTIONS + 至少 1 条 open_questions |
| 2 | 对 open_questions 做回复（带 sessionId） | WAITING_ANSWERS → DRAFT_READY | DRAFT（草稿 Markdown + prompt_to_user） |
| 3 | 对草稿回复「确认」或具体修改意见（带同一 sessionId） | DRAFT_READY → DEFENDING | 若完整：FINAL_DOC；否则 OPEN_QUESTIONS（Defender 追问） |
| 4（可选） | 对 Defender 追问做补充（带同一 sessionId） | DEFENDING | 再次检查，通过则 FINAL_DOC，否则继续 OPEN_QUESTIONS |

---

## 三、逐步操作说明

### 第 1 回合：发起需求（新会话）

**请求示例（curl）：**

```bash
curl -X POST http://localhost:8000/api/agent \
  -H "Content-Type: application/json" \
  -d '{"text": "系统改动点：三分法调仓的前端页面去掉建议追加金额"}'
```

**预期：**

- 无 `sessionId`，且文本命中 ORCH_FLOW 意图；
- 后端创建会话，调用 KB 做一次检索，生成 `open_questions`（来源为基于需求的规则，非固定两条）；
- 响应中：
  - `sessionId`：一串 UUID，**后续回合必须原样带上**；
  - `payloadType`: `"OPEN_QUESTIONS"`；
  - `content.questions`: 至少 1 条问题，例如「请确认该需求涉及的具体页面/模块与约束（或补充说明），回复后继续。」

**检查点：**

- 返回了 `sessionId` 和 `questions`；
- 本回合**没有**返回 DRAFT 或 FINAL_DOC（COLLECT 后停步）。

---

### 第 2 回合：回答 open_questions

**请求示例：** 将上一步返回的 `sessionId` 填入下面。

```bash
curl -X POST http://localhost:8000/api/agent \
  -H "Content-Type: application/json" \
  -d '{
    "sessionId": "<上一步返回的 sessionId>",
    "text": "仅出现在【确认调仓明细页面】。仅隐藏该文案，不改后端逻辑和调仓方式。"
  }'
```

**预期：**

- 后端用「user_request + 用户回复」再调一次 KB，更新 knowledge 与 requirement_structured；
- 生成与 demand_analysis_doc_v1 对齐的草稿，并**仅返回草稿展示**（Confirmer 的 display_content + prompt_to_user）；
- 响应中：
  - `payloadType`: `"DRAFT"`；
  - `content.markdown`: 草稿正文（一、业务需求；二、系统现状；三、系统改动点）；
  - `content.prompt_to_user`: 如「请确认以上内容是否无误，确认后将继续做完整性检查并生成最终文档。」

**检查点：**

- 本回合**没有**直接返回 FINAL_DOC（BUILD_DRAFT 后停步）；
- 草稿中为「改动总览」「通知改动」等 schema 字段，无旧版「business_changes」等。

---

### 第 3 回合：对草稿确认或修改

**请求示例：**

```bash
curl -X POST http://localhost:8000/api/agent \
  -H "Content-Type: application/json" \
  -d '{
    "sessionId": "<同一 sessionId>",
    "text": "确认"
  }'
```

**预期（用户说「确认」）：**

- Confirmer 解析为 status = `confirmed`；
- 进入 DEFEND_CHECK：按 schema 必填与占位检查草稿；
  - **若完整**：调用 Editor 生成最终文档，返回 `payloadType`: `"FINAL_DOC"`，`content.markdown` 为正式版需求分析文档；
  - **若不完整**：返回 `payloadType`: `"OPEN_QUESTIONS"`，`content.questions` 为 Defender 的追问（如「请补充改动总览…」），会话状态为 DEFENDING。

**若用户回复具体修改意见（如「把产品化表述改成…」）：**

- Confirmer 解析为 status = `revised`，将建议合并进 draft 后同样进入 DEFEND_CHECK，同上。

**检查点：**

- 确认后要么得到 FINAL_DOC，要么得到 Defender 追问（OPEN_QUESTIONS），不会同轮既出草稿又出最终文档；
- 最终文档含「一、业务需求」「二、系统现状」「三、系统改动点」及「待澄清项记录」（若有 clarification_log）。

---

### 第 4 回合（可选）：回答 Defender 追问

若第 3 回合返回的是 OPEN_QUESTIONS（Defender 追问）：

**请求示例：**

```bash
curl -X POST http://localhost:8000/api/agent \
  -H "Content-Type: application/json" \
  -d '{
    "sessionId": "<同一 sessionId>",
    "text": "改动总览：仅前端确认调仓明细页去掉建议追加金额展示；后端与通知无改动。"
  }'
```

**预期：**

- 后端将用户输入写入 draft 的 change_overview（或对应缺失项），并追加到 clarification_log（source: defend）；
- 再次执行 DEFEND_CHECK；通过则返回 FINAL_DOC，否则继续返回 OPEN_QUESTIONS。

---

## 四、预期最终文档结构（FINAL_DOC）

- **一、业务需求**：需求来源、产品化表述；
- **二、系统现状**：业务规则与逻辑、前端现状、后端现状、通知/消息现状；
- **三、系统改动点**：改动总览、前端改动点、后端改动点、通知改动点；可选「风险与回滚要点」；
- **待澄清项记录**（若有）：各轮问题与用户答案（来源：collect / defend）。

---

## 五、常见问题

| 现象 | 可能原因 |
|------|----------|
| 第 1 回合就返回 KB_ANSWER 而不是 OPEN_QUESTIONS | 意图被识别为「查知识库」；改用「系统改动点：…」或「改动点：…」等表述 |
| 第 2 回合没有返回 DRAFT | 未带对 sessionId，或 session 已过期（内存会话重启会清空） |
| 第 3 回合一直返回 OPEN_QUESTIONS | Defender 检查到必填仍为占位（含「（待」）；按追问补充具体内容后再发一轮 |
| 最终文档里没有「待澄清项」 | 若从未触发 Defender 追问或未回答，clarification_log 可能仅含 COLLECT 一轮 |

---

## 六、用前端做同一流程

1. 打开前端页面，**不要**带 sessionId（新会话）。
2. 输入：`系统改动点：三分法调仓的前端页面去掉建议追加金额`，发送。
3. 应看到助手回复若干条「问题」，并可能展示「请按上述问题…」类提示；记下此时对话对应的 sessionId（若前端有展示或从网络请求中取）。
4. 输入对问题的回复（如「仅出现在【确认调仓明细页面】。仅隐藏该文案…」），发送。
5. 应看到草稿正文 + 「请确认以上内容…」；再输入「确认」发送。
6. 若完整则看到最终文档；若 Defender 追问则看到问题列表，再补充内容发送，直到出现最终文档。

以上步骤与「三、逐步操作说明」一一对应，仅通过前端 UI 完成各轮输入与查看返回。
